name: Plugin Validation

on:
  push:
    branches: [main, master]
    paths:
      - '.claude-plugin/**'
      - 'agents/**'
      - 'commands/**'
      - 'skills/**'
      - 'hooks/**'
      - 'scripts/**'
      - '*.mcp.json'
      - '.github/workflows/**'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install linting tools
        run: pip install mypy types-PyYAML ruff

      - name: Validate plugin
        run: |
          echo "=== Plugin Validation (strict mode) ==="
          echo ""

          # Check that validator script exists
          if [ ! -f "scripts/validate_plugin.py" ]; then
            echo "ERROR: scripts/validate_plugin.py not found"
            exit 1
          fi

          # Run validator with pyyaml dependency
          # Exit codes: 0=pass, 1=CRITICAL, 2=MAJOR, 3=MINOR
          # Block on CRITICAL and MAJOR; allow MINOR (advisory)
          set +e
          uv run --with pyyaml --with types-PyYAML python scripts/validate_plugin.py . --verbose
          exit_code=$?
          set -e

          echo ""
          if [ $exit_code -eq 0 ]; then
            echo "=== Validation PASSED (no issues) ==="
            exit 0
          elif [ $exit_code -eq 3 ]; then
            echo "=== Validation PASSED with MINOR advisories (exit code: 3) ==="
            echo "MINOR issues are soft recommendations, not blocking."
            exit 0
          else
            echo "=== Validation FAILED (exit code: $exit_code) ==="
            exit $exit_code
          fi
